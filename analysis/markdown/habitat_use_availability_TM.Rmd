---
title: "Habitat Use versus Availability by Juvenile Chinook Salmon in Winter Months, Lemhi River"
author:
  - Tulley Mackey:
      email: tulley.mackey@mthoodenvironmental.com
      institute: [mhe_salmon]
      correspondence: true
  - Kevin E. See:
      email: Kevin.See@dfw.wa.gov
      institute: [wdfw]
      correspondence: false
  - Nick Porter:
      email: Nicholas.Porter@merck.com
      institute: [biomark]
      correspondence: true
  - Mike Hall:
      email: Mike.Hall1@merck.com
      institute: [biomark]
      correspondence: false
  - Richie Carmichael:
      email: Richard.Carmichael@merck.com
      institute: [biomark]
      correspondence: false
  - Michael W. Ackerman:
      email: mike.ackerman@mthoodenvironmental.com
      institute: [mhe_mccall]
      correspondence: true 
institute:
  - mhe_salmon: Mount Hood Environmental, 1009 South Daisy Street, Salmon, Idaho, 83467, USA
  - wdfw: Washington Department of Fish and Wildife, Fish Program, Science Division, 1111 Washington Street NE, Olympia, Washington, 98501, USA
  - biomark: Biomark, Inc., 705 South 8th Street, Boise, Idaho, 83702, USA
  - mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::word_document2:
    fig_caption: yes
    reference_docx: "../templates/template.docx"
    number_sections: FALSE
    toc: no
    always_allow_html: true
    fig_width: 6
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
csl: "../templates/american-fisheries-society.csl"
bibliography:
  - AckermanLibrary.bib
always_allow_html: yes
---

```{r setup, echo = FALSE, message = F, warning = F}
library(here)
library(knitr)
library(kableExtra)

knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = here("analysis/figures//"),
  dpi = 300
)

```

```{r packages}
# load packages
library(tidyverse)
library(here)
library(magrittr)
library(janitor)
library(sf)
library(EMT)
library(DescTools)
library(broom)

theme_set(theme_bw())

```

```{r load-data}
# habitat availability and use datasets
load(here("analysis/data/derived_data/habitat_available.rda"))
load(here("analysis/data/derived_data/habitat_use.rda"))

# read in csv for availability and use depths and velocities
avail_use_depth <- read_csv(here("analysis/data/derived_data/avail_use_depth.csv"))
avail_use_vel   <- read_csv(here("analysis/data/derived_data/avail_use_vel.csv"))

```

```{r clean-data}
xs_all = xs_use %>%
  mutate(source = "use") %>%
  bind_rows(xs_avail %>%
              mutate(source = "avail")) %>%
  clean_names() %>%
  # improve some column names
  rename(release_loc = location,
         release_date = release,
         xs_name = name,
         stream_name = stream_nam,
         sin_cat = category,
         frazil_ice = frazel_ice) %>%
  # correct the code for small side channels
  mutate(channel_unit_type = recode(channel_unit_type,
                                    `SC` = "SSC")) %>%
  # round distance to cover to nearest 0.1m and rename
  mutate(distance_to_cover = round(distance_to_cover_round_to_nearest_0_1m, 1)) %>%
  select(-distance_to_cover_round_to_nearest_0_1m) %>%
  # fix some names within dominant substrate and reorder levels
  mutate(dominant_substrate_1mx1m = fct_recode(dominant_substrate_1mx1m,
                                               Boulder = "boulder",
                                               Cobble = "cobble",
                                               Fines = "silt_fines",
                                               Sand = "sand",
                                               Gravel = "gravel"),
         dominant_substrate_1mx1m = fct_relevel(dominant_substrate_1mx1m,
                                                "Gravel",
                                                after = 2),
         dominant_substrate_1mx1m = fct_relevel(dominant_substrate_1mx1m,
                                                "Sand",
                                                after = 3)) %>%
  # add a variable of whether there's any cover present within 1.5m
  mutate(has_cover = if_else(dominant_cover_type_1_5m_radius %in% c("No Cover", "Unknown") |
                               is.na(dominant_cover_type_1_5m_radius), "No", "Yes")) %>%
  # add variable for new selected habitat (filtering out duplicate selected locations and locations with mean velocity > 0.5 m/s)
  mutate(habitat_selected_new = if_else(habitat_selected == "Selected" & same_location_as_last_survey == "no", "Yes", "No"))

xs_summary = xs_all %>%
  filter(source == "avail") %>%
  group_by(xs_name, sin_cat) %>%
  summarise(n_pts = n_distinct(xs_point_number))

```

# Background

Degradation of tributary habitat has been implicated as a major factor contributing to declines of Pacific salmon *Oncorhynchus* spp. Tributary habitat rehabilitation actions are necessary towards stemming population declines. However, habitat use and preference for juvenile salmonids to inform those rehabilitation actions, particularly during winter months, are not well documented. 

Habitat requirements for fish include physical and biological components necessary to complete life histories and ensure population viability [@Newcomb2007; @Rosenfeld2003]. Habitat availability can be defined as the accessibility of such components by a fish [@Johnson1980]. Alternatively, habitat use is the way a fish exploits the physical and biological resources available to them [@Favrot2018]. Habitat suitability measures a specific available habitat's capacity to support a fish, the most suitable habitats being optimal [@Bovee1986]. Available habitats can be hierarchically characterized by a spectrum ranging from least suitable (i.e., avoided) to most suitable (i.e., optimal). Habitat selection is determined when a fish chooses a physical or biological component from a spectrum of available habitats [@Johnson1980]. If habitat use is proportionally equivalent to habitat availability (i.e., no preference), then habitat use is considered random. However, when a fish selects for a specific physical or biological component given equal available habitat, this is considered preferred habitat (e.g., laboratory experiment: @Johnson1980). Critical habitat provides components essential to sensitive life stages (e.g., early life history: @Pitlo1989, @Newcomb2007).  Winter habitat is thought be critical because of specific biological conditions required by fish for maintenance of body condition and survival during this time period [@Favrot2018]. However, due to extreme environs (e.g., surface ice), little research has characterized winter microhabitat use and suitability empirically for Pacific salmon juveniles [@Huusko2007].

## Objectives

The goal of this study was to characterize microhabitat use and preference for juvenile Chinook salmon *O. tshawytscha* in the lower Lemhi River during winter months. Habitat availability and use data were collected in the lower Lemhi River using methods similar to those described by @Favrot2018 previously implemented in Catherine Creek, Oregon. We used similar habitat availability and use data to describe habitat selection and preference of juvenile Chinook salmon overwintering in the lower Lemhi River, which can in turn be used to inform target habitat conditions to be used in habitat restoration planning and designs.


# Methods

## Habitat Availability

```{r hab-avail-data}
center_pts_all = st_read("S:/main/data/habitat/lemhi_telemetry/availability/raw/Centerline_XS_Intersects.shp",
                         quiet = T) %>%
  st_zm() %>%
  mutate(Category = factor(Category,
                           levels = c("Low",
                                      "Med",
                                      "High")))

```

Microhabitat availability data were collected in the lower Lemhi River using line-transect survey techniques similar to those described by @Favrot2018. Line-transect techniques can minimize measurement error and are more repeatable than visual techniques [@McMahon1996; @Stanfield1998]. Microhabitat availability data were collected during base-flow conditions in August 2019 and variables measured at each transect point corresponded to microhabitat use variables (described below). Points were placed each 1 m along a linear network of the lower Lemhi River from its confluence with Hayden Creek downstream to its confluence with the Salmon River, resulting in `r prettyNum(nrow(center_pts_all), big.mark = ",")` points in total. Each point was then categorized as occurring within a low, medium, or high sinuosity reach (calculated at the 500m reach scale) of the lower Lemhi River (Table \@ref(tab:sin-table)).

```{r sin-table}
sin_tbl = tibble(
  Category = c("Low", "Med", "High"),
  Minimum = c(
    min(center_pts_all$Sinuosity[center_pts_all$Category == "Low"]),
    min(center_pts_all$Sinuosity[center_pts_all$Category == "Med"]),
    min(center_pts_all$Sinuosity[center_pts_all$Category == "High"])
  ),
  Maximum = c(
    max(center_pts_all$Sinuosity[center_pts_all$Category == "Low"]),
    max(center_pts_all$Sinuosity[center_pts_all$Category == "Med"]),
    max(center_pts_all$Sinuosity[center_pts_all$Category == "High"])
  ),
  `Length (m)` = c(
    nrow(center_pts_all[center_pts_all$Category == "Low", ]),
    nrow(center_pts_all[center_pts_all$Category == "Med", ]),
    nrow(center_pts_all[center_pts_all$Category == "High", ])
  )
) %>%
  kbl(caption = "The number of points within each sinousity category including the minimum and maximum sinuosity values for reach category.",
      format.args = list(digits = 4,
                         big.mark = ",")) %>%
  kable_styling(position = "center", full_width = F)
sin_tbl

```

We then randomly sampled an approximately equal number of points within each sinuosity category (Table \@ref(tab:xs-table)) and transects were placed at a right angle to the flow at each of the sampled points. At each transect, we then started at the wetted width midpoint (`xs_point_number = 0`) of the river and sampled every 1m to river right and river left (facing downstream), including the midpoint, to the wetted margin. Points to river right were designated positive (+) and points towards river left were designated negative (-) and habitat availability measurements were taken at each point.<!-- Need to verify those previous statements. Did we sample each meter and was river right (facing downstream) designated positive?--> Habitat availability measurements described channel unit type, bank condition, dominant substrate, availability of substrate concealment, presence of adjacent side channels, dominant cover type, and distance to cover. In addition, depth and velocity estimates for each point were available from LiDAR-derived 2D numerical models. In total, habitat measurements were collected from `r nrow(xs_summary)` transects and `r prettyNum(sum(xs_summary$n_pts), big.mark = ",")` points, resulting in an average of `r round(sum(xs_summary$n_pts) / nrow(xs_summary), 1)` points per transect.

```{r xs-table}
xs_tbl = tibble(
  Category = c("Low", "Med", "High"),
  `n Transects` = c(
    nrow(xs_summary[xs_summary$sin_cat == "Low", ]),
    nrow(xs_summary[xs_summary$sin_cat == "Med", ]),
    nrow(xs_summary[xs_summary$sin_cat == "High", ])
  ),
  `n Transect Points` = c(
    sum(xs_summary$n_pts[xs_summary$sin_cat == "Low"]),
    sum(xs_summary$n_pts[xs_summary$sin_cat == "Med"]),
    sum(xs_summary$n_pts[xs_summary$sin_cat == "High"])
  )
) %>%
  mutate(`Avg. Points per Transect` = round(`n Transect Points` / `n Transects`, 1)) %>%
  kbl(caption = "The number of points within each sinousity category including the minimum and maximum sinuosity values for reach category.",
      format.args = list(digits = 4,
                         big.mark = ",")) %>%
  kable_styling(position = "center", full_width = F)
xs_tbl

```

## Habitat Use

Microhabitat use data were collected from radio-tagged juvenile Chinook salmon in the lower Lemhi River beginning in November 2019 through March 2020. For this study, a total of 279 fish were tagged from October 9 - 31, 2019 at three rotary screw trap (RST) locations in the Lemhi River: upper Lemhi RST (LEMTRP), Hayden Creek RST (HYDTRP), and lower Lemhi RST (LLRTRP). <!-- Were any fish from the lower Lemhi RST actually used in this assessment? The initial intent was to only use those fish tagged at the upper traps for this habitat availability and use assessment. Fish tagged at the lower Lemhi RST were used to assess movement and distribution of DSR juveniles into and through the Salmon River. Please clarify and make sure sample sizes are correct.-->Advanced Telemetry Systems, Inc. (ATS; hhtps://atstrack.com) radio transmitters (Model #ST100L) were surgically implanted into the abdomen of Chinook salmon presmolts (juveniles surviving to their first winter prior to spring emigration), ranging in length from 98 - 138 mm and weight from 10.4 - 31.1 g. Fish were also implanted with a Passive Integrated Transponder tag (PIT tag). Tagged fish were held for a minimum of six hours in live wells and released at night below the tagging sites once they had fully recovered from surgery.

Because of limited battery life, radio tags were programmed to operate in three batches to cover the entire winter season. Batch 1 transmitters (181 fish) were programmed to operate continuously upon activation, batch 2 transmitters (47 fish) operated for an hour upon activation then shutdown to reactivate at day 50, and batch 3 transmitters (51 fish) operated for an hour upon activation then shutdown to reactivate at day 100.<!-- Make sure this is correct after deciding upon inclusion/exclusion of lower Lemhi RST fish -->

Throughout the winter, mobile tracking surveys were completed by boat and on foot, dependent on weather and river conditions.  Surveys covered 50 km of the lower Lemhi River from its confluence with Hayden Creek downstream to its confluence with the Salmon River and were completed approximately every two weeks. When a transmitter was detected, surveyors pin-pointed the signal location to the finest scale possible (typically $< 1 m^2$), attempted to determine whether the tag was in a live fish, and recorded the location using an EOS Arrow 100 GNSS GPS receiver. Habitat use metrics describing channel unit type, bank condition, dominant substrate, availability of substrate concealment, dominant cover type, distance to cover, depth, and mean column velocity, were also collected at each tag location for comparison with the habitat availability dataset. 

```{r}
# filter for tags recovered by unique radio tag
use_recovered <- xs_use %>%
  filter(tag_status == "Recovered") %>%
  distinct(radio_frequency)

# summarize count of unique radio tags detected 
use_unique <- xs_use %>%
  distinct(radio_frequency) 

#summarize count of qualified, unique observations
use_selected <- xs_all %>%
  filter(habitat_selected_new == "Yes")

```

Mobile tracking surveys resulted in the detection of `r nrow(use_unique)` unique radio tags of which `r nrow(use_recovered)` were physically recovered (one confirmed mortality). The high recovery rate of detected tags (22%) combined with the inability to confirm tag detections as live fish created some uncertainty about the validity of fish use data. <!-- I don't love this previous statement. First, 22% doesn't seem high. What do you mean here? Second, this is a limitation among many radio tracking studies. Isn't it sufficient instead to say something like "We used a decision tree developed using information from Holleman et al. (2022) and professional expertise in an attempt to identify those locations being utilized by fish.". I don't love that statement, but something along those lines. Otherwise, let's leave discussion of our limitations for the Discussion section. -->To address this, a decision tree was developed based on professional expertise and published literature [@Holleman2022] to qualify tag detection locations as selected for habitat (Figure \@ref(fig:tree-fig)). Using the decision tree, `r nrow(use_selected)` unique selected habitat locations were identified.<!-- How many fish were included in these 74 unique locations-->

```{r tree-fig, out.width = "500px", fig.align = "center", fig.cap = "Decision tree for determining qualified tag detection locations as selected habitat." }
knitr::include_graphics(here("analysis/images/D_tree.jpg"))

```

## Habitat Availability Power Analysis

```{r read_dv_data}
# read in depth and velocities from the habitat availability transects
xs_raster = crossing(metric = c("depth", "velocity"),
                     sin_class = c("Low", "Med", "High")) %>%
  mutate(sample_xs = map2(metric,
                          sin_class,
                          .f = function(x, y) {
                            st_read(paste0("S:/main/data/habitat/lemhi_telemetry/availability/raw/cross_sections/DV_extract/", y,
                                           "_", str_sub(x, 0 ,1), ".shp"),
                            quiet = T) %>%
                              dplyr::select(Name:Sinuosity, 
                                            Category,
                                            raster_val = RASTERVALU) %>%
                              mutate_at(vars(raster_val),
                                        list(~ if_else(. == -9999,
                                                       NA_real_,
                                                       .))) %>%
                              mutate(metric = x)
                            }))

# depth & velocity cross section values - sf object
dv_sf = xs_raster %>%
  select(-metric) %>%
  unnest(cols = sample_xs) %>%
  st_as_sf()

# depth & velocity cross section values - data frame
dv_df = dv_sf %>%
  st_drop_geometry() %>%
  as_tibble()

# get all available depths & velocities from the complete rasters
load("S:/main/data/habitat/lemhi_telemetry/availability/prepped/d_v_avail_sin.rda") # d_v_avail_sin

# compose a data frame for comparison
comp_df = dv_df %>%
  select(metric,
         sin_class,
         raster_val) %>%
  mutate(source = "sampled") %>%
  bind_rows(d_v_avail_sin %>%
              as_tibble() %>%
              select(-ID) %>%
              rename(raster_val = value) %>%
              mutate(source = "all")) %>%
  mutate(sin_class = factor(sin_class,
                            levels = c("Low", "Med", "High")),
         metric = str_to_title(metric))

```

Prior to evaluating for habitat selection or preference, we first wanted to assess whether the habitat availability data collected during August 2019 was sufficient to capture the overall distribution of available habitat throughout the lower Lemhi River, or whether addition habitat availability data were needed. A total of `r nrow(xs_summary)` transects (cross-sections) were sampled during August 2019 based on a stratified sample where strata were defined by low, medium, and high sinuosity (Tables \@ref(tab:sin-table) & \@ref(tab:xs-table)). We started by examining the depth and velocity values available from raster datasets derived from 2D numerical models for the entire lower Lemhi. We then extracted depth and velocity values from points along the sampled transects, and compared those distributions with the distributions of depth and velocity for the entire available raster. Our hypothesis is that if the distributions are similar between the entire raster and the sampled transects, then the sample has done an adequate job of capturing the distribution of available habitat.

## Habitat Preference

After filtering the identified radio tags to include only those fish that we deemed selected a given location, we then compared the total available habitat in the lower Lemhi River to the habitat that was selected by radio-tagged Chinook salmon presmolts. Comparisons were made for the following habitat characteristics:

* Sinuosity
* Stream Depth and Velocity
* Channel Unit Type
* Substrate Concealment
* Cover

### Sinuosity

We estimate the proportion of the total available habitat in the lower Lemhi River that fell into each of the sinuosity categories (Table \@ref(tab:sin-table)) which was compared to the proportion of each category that Chinook salmon presmolts used. 

### Depth and Velocity

Depth (m) and mean column velocity (m/s) were measured at 47 of the `r nrow(use_selected)` selected habitat locations during typical winter flows. Environmental conditions at the time of sampling, primarily surface ice and depth, prevented collection of depth and velocity measurements at some locations, likely introducing some bias e.g., use locations with the greatest depths were most difficult to measure. However, because our decision tree accounted for velocity limits of sustained swimming of juvenile salmonids, we feel confident the locations where mean column velocity was measured is a representative sample of habitat use locations in the lower Lemhi.<!-- This last statement is likely more appropriate for the Discussion. I think it's still worth recognizing here, but might be a more simple statement like "This bias is likely less prevalent in the velocity use dataset, as juvenile Chinook salmon tend to select areas of lower velocities during winter months (citation) and we were more able to sample those locations." Something to that effect.-->

We compared the available depths and velocities at the transect location points (n = `r prettyNum(sum(xs_summary$n_pts), big.mark = ",")`; derived from raster available from 2D-numerical models) to the measured depths and velocities taken in the field during microhabitat use surveys. <!-- Is there a reason for not just using all depths and velocities from the raster, I can't recall. It seems we could fairly easily make that comparison.-->We used a variance test (F test; how far each data point is from the group mean), to evaluate variances between the habitat availability and habitat use datasets. This led us to use an unpooled, two-sample test (Welch test) to determine if there's a significant difference (p-value < 0.05) between mean available depth and velocity and mean selected depth and velocity in the lower Lemhi.     

### Channel Unit Type

Channel unit types included pools, riffles, runs, rapid+, small side-channels (SSC), and off-channel areas (OCA), similar to channel units delineated using the DASH protocol [@Carmichael2019]. Because there are multiple types of channel units, we employed a goodness-of-fit test for discrete multivariate data. This test compares the observed channel unit types that radio-tagged juveniles were observed using to the proportion of channel unit types from the habitat availability dataset. The null hypothesis was that radio-tagged juvenile Chinook salmon would be found in channel units in the same (or similar) proportion to what is available. Because there are `r n_distinct(xs_all$channel_unit_type)` distinct channel unit types, this leads to a large number of potential arrangements. Therefore, we used a Monte Carlo approach to simulate `r prettyNum(1e5, scientific=FALSE, big.mark = ",")` samples of $n$ observations ($n$ being the number of selected "use" channel units) using the habitat availability proportions of channel unit types. The p-value is then calculated by summing the relative frequencies of outcomes occurring less frequently than the observed ones, so a low p-value indicates that the observed "use" channel types are distributed differently that the available ones, suggesting that fish are not randomly distributed in overwinter habitat. We also used a log likelihood ratio goodness of fit test (G-test).

### Concealment

At each point of habitat availability transects and at observed "use" locations by radio-tagged individuals, we estimated whether concealment habitat was available to juvenile Chinook salmon. <!-- It might be worth including how we estimated availability (or not) of available concealment habitat. I can't recall the details. And is that a citable method, perhaps from CHaMP? -->Because concealment is binary (either available or not), we tested whether there were differences between habitat availability and use using a Chi-squared test, as well as a G-test.

### Cover

We determined whether fish cover was available within 1.5 m of each habitat availability transect point and at each "use" location. Cover types considered included artificial cover, aquatic vegetation, boulders, small and large wood, terrestrial vegetation, and undercut banks. Here, we grouped all types of cover into a single category, and compared whether cover was available with the category of "no cover". This resulted in a binary variable, like concealment, allowing us to also use the Chi-squared and G-test.


# Results

## Habitat Availability Power Analysis

Comparisons of the distributions of depths and velocities estimated from 1) the randomly placed transects used to estimate habitat availability, and 2) the entirety of the rasters derived from 2D numerical models were favorable (Figure \@ref(fig:dist-fig)). Distributions of depths and velocities were similar among all sinuosity categories (Figure \@ref(fig:dist-fig)). These findings suggest that the habitat availability data collected during August 2019 were sufficient to capture the available habitat throughout the lower Lemhi River.

```{r dist-fig, fig.cap = "Density plots of depth and velocity, colored by whether taken from the entire raster (all) or the sampled transects (sampled), and faceted by sinuosity category."}
comp_df %>%
  ggplot(aes(x = raster_val,
             color = source,
             fill = source)) +
  geom_density(alpha = 0.3) +
  scale_color_brewer(palette = 'Set1',
                     name = 'Source') +
  scale_fill_brewer(palette = 'Set1',
                     name = 'Source') +
  facet_grid(sin_class ~ metric,
             scales = 'free') +
  # facet_wrap(~ metric + sin_class, 
  #            scales = 'free',
  #            nrow = 2) +
  theme(legend.position = "bottom") +
  labs(x = 'Raster Value')

```

## Habitat Preference

### Sinuosity

Sinuosity categories selected by radio-tagged juvenile Chinook salmon, during later fall and winter months, were similar to the proportions of available habitat (Figure \@ref(fig:sin-use)). In other words, Chinook salmon presmolts were *not* observed using "high" sinuosity reaches of the lower Lemhi River at a higher rate than was available, as we might expect. However, sinuosity categories were calculated at the 500 m reach scale, and this observation could be (at least partially) due to fish not selecting for habitat at this more coarse (e.g., reach) scale, but rather at a finer (e.g., microhabitat) scale.<!-- This final statement might be more appropriate for the Discussion.--> 

```{r sin-use, fig.cap = "Percent of available and selected habitat by sinuosity category in the lower Lemhi."}
# percentage available habitat by sinuosity
sin_all <- center_pts_all %>%
  st_drop_geometry() %>%
  select(Category) %>%
  count(Category) %>%
  mutate(Percentage = n/sum(n)) %>%
  add_column(Habitat = "Available")

# percentage use habitat by sinuosity 
sin_use <- xs_use %>%
  filter(habitat_selected == "Selected" & same_location_as_last_survey == "no") %>%
  select(Category) %>%
  count(Category) %>%
  mutate(Percentage = n/sum(n)) %>%
  add_column(Habitat = "Use") %>%
  bind_rows(sin_all) %>%
  ggplot(mapping = aes(x=Category, 
                       y=Percentage, 
                       fill = Habitat)) +
  geom_bar (position = "dodge", 
            stat = "identity") +
  scale_fill_brewer(palette = "Set2") +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "bottom") +
  ylab("Proportion") +
  xlab("Sinuosity Category")
sin_use

```

### Depth and Velocity

The distributions between available stream depths and those depths used by Chinook salmon presmolts were similar (Figure \@ref(fig:depth-fig)); despite the "used" mean depth being significantly lower than the available mean (p < 0.05; Table \@ref(tab:depth-tab). However, this significance could (at least partially) be explained by a potential sampling bias explored further in the [Discussion](#discussion).

```{r depth-fig, fig.cap = "Distributions of all available stream depths in the lower Lemhi River derived from a 2D numerical model (available) and depths used by radio-tagged juvenile Chinook salmon during late fall and winter months (use)."}
# boxplot comparisons for available/use depths/velocities
depth_box = ggplot(avail_use_depth,
                   aes(x = Habitat, 
                       y = Depth, 
                       fill = Habitat)) + 
  geom_boxplot() +
  theme(axis.text.x = element_blank(),
        legend.position="bottom") +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "",
       y = "Depth (m)")
depth_box

```

```{r depth-tab}
# Welch t-test for depth
depth_tab = t.test(Depth ~ Habitat, data = avail_use_depth) %>%
  tidy() %>%
  select(estimate1,
         estimate2,
         p.value) %>%
  rename(`Mean Available Depth (m)` = estimate1,
         `Mean Select Depth (m)` = estimate2,
         `Welch t-test p-value` = p.value) %>%
  kable(caption = "Estimated mean depth for available and selected habitat and Welch t-test p-value.") %>%
  kable_styling(position = "center", 
             full_width = F)
depth_tab

```

Mean stream velocities used by Chinook salmon presmolts were significantly lower than those available throughout the lower Lemhi River (Figure \@ref(fig:vel-fig); Table \@ref(tab:vel-tab), suggesting that juvenile Chinook salmon are selecting for slower water habitats during late fall and early winter months.

```{r vel-fig, fig.cap = "Distributions of all available stream velocities in the lower Lemhi River derived from a 2D numerical model (available) and velocities used by radio-tagged juvenile Chinook salmon during late fall and winter months (use)."}
# Basic box plot
vel_box = ggplot(avail_use_vel, 
                 aes(x = Habitat,
                     y = Velocity, 
                     fill = Habitat)) + 
  geom_boxplot() +
  theme(axis.text.x = element_blank(),
        legend.position="bottom") +
  scale_fill_brewer(palette = "Set2") +
  labs(x = "",
       y = "Velocity (m/s)")
vel_box

```

```{r vel-tab}
# Welch t test for velocity
vel_tab = t.test(Velocity ~ Habitat, 
               data = avail_use_vel) %>%
  tidy() %>%
  select(estimate1,
         estimate2,
         p.value) %>%
  rename(`Mean Available Velocity (m/s)` = estimate1,
         `Mean Select Velocity (m/s)` = estimate2,
         `Welch t-test p-value` = p.value) %>%
  kable(caption = "Estimated mean velocity for available and selected habitat and Welch t-test p-value.") %>%
  kable_styling(position = "center", 
                full_width = F)
vel_tab

```

### Channel Unit Type

There were significant differences in the distribution of channel unit types used by radio-tagged juvenile Chinook salmon during winter months and what is available throughout the lower Lemhi River, across all three sinuosity categories (Table \@ref(tab:cu-tab)). Juvenile Chinook salmon appear to use pools and off-channel areas at a higher proportion relative to their availability, and riffles at a lower proportion compared to what is available (Figure \@ref(fig:cu-fig)).

```{r cu-fig, fig.cap = "Percent of channel unit types available in the entire lower Lemhi compared with percent where fish were using them, faceted by low, medium and high sinuosity classes."}
# channel unit bar plot by sinuosity category
cu_fig = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  ggplot(aes(x = source,
             fill = channel_unit_type)) +
  geom_bar(position = position_fill()) +
  scale_fill_brewer(palette = "Set2",
                    name = "CU Type") +
  facet_wrap(~ sin_cat) +
  labs(x = "Data Set",
       y = "Percentage")
cu_fig

```

```{r cu-test}
cu_prop_test = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  group_by(sin_cat, 
           source,
           channel_unit_type) %>%
  summarize(n_found = n(),
            .groups = "drop") %>%
  # fill in missing groups w/ NA
  full_join(tidyr::expand(.,
                          sin_cat,
                          source,
                          channel_unit_type),
            by = c("sin_cat",
                   "source",
                   "channel_unit_type")) %>%
  # replace NAs with 0s
  mutate(across(n_found,
                replace_na,
                0)) %>%
  # calculate proportions
  group_by(sin_cat,
           source) %>%
  mutate(prop = n_found / sum(n_found)) %>%
  ungroup() %>%
  arrange(sin_cat,
          source,
          channel_unit_type) %>%
  # nest data by sinuosity category
  nest(data = -sin_cat) %>%
  mutate(mn_test = map(data,
                       .f = purrr::quietly(function(x) {
                         obs_n = x %>%
                           filter(source == "use") %>%
                           pull(n_found)
                         exp_prop = x %>%
                           filter(source == "avail") %>%
                           pull(prop)
                         set.seed(6)
                         mn_test = EMT::multinomial.test(observed = obs_n,
                                                         prob = exp_prop,
                                                         useChisq = F,
                                                         MonteCarlo = T,
                                                         ntrial = 1e5)
                         return(mn_test)
                       })),
         mn_test = map(mn_test,
                       "result"),
         mn_test_stat = map_chr(mn_test, 
                             "stat"),
         mn_p_value = map_dbl(mn_test,
                           "p.value")) %>%
  mutate(g_test = map(data,
                      .f = function(x) {
                        obs_n = x %>%
                          filter(source == "use") %>%
                          pull(n_found)
                        exp_prop = x %>%
                          filter(source == "avail") %>%
                          pull(prop)
                        g_test = DescTools::GTest(x = obs_n,
                                                  p = exp_prop,
                                                  correct = "williams")
                        return(g_test)
                      }),
         g_test_stat = map_chr(g_test,
                               "method"),
         g_p_value = map_dbl(g_test,
                             "p.value"))

```

```{r cu-tab}
# channel unit table
cu_tab = cu_prop_test %>%
  select(sin_cat,
         mn_p_value,
         g_p_value) %>%
  rename(`Sinuosity Category` = sin_cat,
         `Multinomial p-value` = mn_p_value,
         `G-test p-value` = g_p_value) %>%
  kable(caption = "P-values of multinomial and G-tests for differences in channel unit type proportions between available and selected habitat.") %>%
  kable_styling(position = "center", 
                full_width = F)
cu_tab

```

### Concealment

We observed little/no difference between the proportion of locations where concealment substrate was available and locations used by juvenile Chinook salmon with concealment habitat, for both the medium and high sinuosity categories (Figure \@ref(fig:conceal-fig)). There was a significant difference within the low sinuosity category (Table \@ref(tab:conceal-tab)); however; Figure \@ref(fig:conceal-fig) indicates that in low sinuosity reaches, fish were more likely to select habitat that does not contain substrate concealment, contrary to our suspicions.

```{r conceal-fig, fig.cap = "Proportion of locations where concealment habitat was available throughout the lower Lemhi River compared with the proportion where fish had selected, faceted by low, medium and high sinuosity classes."}
# concealment figure
conceal_fig = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  filter(substrate_concealment %in% c("N", "Y")) %>%
  ggplot(aes(x = source,
             fill = substrate_concealment)) +
  geom_bar(position = position_fill()) +
  scale_fill_brewer(palette = "Set2",
                    name = "Concealment") +
  facet_wrap(~ sin_cat) +
  labs(x = "Data Set",
       y = "Percentage")
conceal_fig

```

```{r conceal-test}
conceal_test = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  filter(substrate_concealment %in% c("N", "Y")) %>%
  mutate(across(substrate_concealment,
                fct_drop)) %>%
  group_by(sin_cat,
           source,
           substrate_concealment) %>%
  summarize(n_found = n(),
            .groups = "drop") %>%
  # fill in missing categories w/ NA
  full_join(tidyr::expand(.,
                          sin_cat,
                          source,
                          substrate_concealment),
            by = c("sin_cat",
                   "source",
                   "substrate_concealment")) %>%
  # fill in NAs
  mutate(across(n_found,
                replace_na,
                0)) %>%
  group_by(sin_cat, source) %>%
  mutate(prop = n_found / sum(n_found)) %>%
  ungroup() %>%
  arrange(sin_cat,
          source,
          substrate_concealment) %>%
  nest(data = -sin_cat) %>%
  mutate(mn_test = map(data,
                    .f = purrr::quietly(function(x) {
                      obs_n = x %>%
                        filter(source == "use") %>%
                        pull(n_found)
                      exp_prop = x %>%
                        filter(source == "avail") %>%
                        pull(prop)
                      set.seed(6)
                      mn_test = EMT::multinomial.test(observed = obs_n,
                                                      prob = exp_prop,
                                                      useChisq = F,
                                                      MonteCarlo = T,
                                                      ntrial = 1e5)
                      return(mn_test)
                    })),
         mn_test = map(mn_test,
                       "result"),
         mn_test_stat = map_chr(mn_test, 
                                "stat"),
         mn_p_value = map_dbl(mn_test,
                              "p.value")) %>%
  mutate(g_test = map(data,
                      .f = function(x) {
                        # obs_n = x %>%
                        #   filter(source == "Use") %>%
                        #   pull(n_found)
                        # exp_prop = x %>%
                        #   filter(source == "Avail.") %>%
                        #   pull(prop)
                        # g_test = DescTools::GTest(x = obs_n, 
                        #                           p = exp_prop,
                        #                           correct = "williams")
                        g_test = x %>%
                          select(-prop) %>%
                          pivot_wider(names_from = source,
                                      values_from = n_found) %>%
                          select(avail, use) %>%
                          as.matrix() %>%
                          DescTools::GTest(correct = "yates")
                        return(g_test)
                      }),
         g_test_stat = map_chr(g_test,
                               "method"),
         g_p_value = map_dbl(g_test,
                             "p.value")) %>%
  mutate(chi2_test = map(data,
                         .f = function(x) {
                           obs_n = x %>%
                             filter(source == "use") %>%
                             pull(n_found)
                           exp_prop = x %>%
                             filter(source == "avail") %>%
                             pull(prop)
                           chi_test = stats::chisq.test(x = obs_n, 
                                                        p = exp_prop)
                           return(chi_test)
                         }),
         chi2_test_stat = map_chr(chi2_test,
                                  "method"),
         chi2_p_value = map_dbl(chi2_test,
                                "p.value"))

```

```{r conceal-tab}
conceal_tab = conceal_test %>%
  select(sin_cat,
         g_p_value,
         chi2_p_value) %>%
  rename(`Sinuosity Category` = sin_cat,
         `G-test p-value` = g_p_value,
         `Chi Squared p-value` = chi2_p_value) %>%
  kable(digits = 5,
        caption = "P-values of G- and Chi-squared tests for differences in availability of concealment between available and selected habitat.") %>%
  kable_styling(position = "center", 
                full_width = F)
conceal_tab

```

### Cover

Radio-tagged juvenile Chinook salmon were more likely to select habitat where some form of cover was available (within a 1.5 m radius), compared to what was available, including across all three sinuosity categories (Figure \@ref(fig:cover-fig); Table \@ref(tab:cover-tab)).

```{r cover-fig, fig.cap = "Proportion of transect points where cover was available throughout the entire lower Lemhi River compared to the proportion where fish had selected, faceted by low, medium, and high sinuosity categories."}
cover_fig = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  ggplot(aes(x = source,
             fill = has_cover)) +
  geom_bar(position = position_fill()) +
  scale_fill_brewer(palette = "Set2",
                    name = "Cover") +
  facet_wrap(~ sin_cat) +
  labs(x = "Data Set",
       y = "Percentage")
cover_fig
   
```

```{r cover-test}
cover_test = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  group_by(sin_cat,
           source,
           has_cover) %>%
  summarize(n_found = n(),
            .groups = "drop") %>%
  # add missing categories
  full_join(tidyr::expand(.,
                          sin_cat,
                          source,
                          has_cover),
            by = c("sin_cat",
                   "source",
                   "has_cover")) %>%
  # fill in NAs with 0
  mutate(across(n_found,
                replace_na,
                0)) %>%
  group_by(sin_cat, source) %>%
  mutate(prop = n_found / sum(n_found)) %>%
  ungroup() %>%
  arrange(sin_cat,
          source,
          has_cover) %>%
  nest(data = -sin_cat) %>%
  mutate(mn_test = map(data,
                       .f = purrr::quietly(function(x) {
                         obs_n = x %>%
                           filter(source == "use") %>%
                           pull(n_found)
                         exp_prop = x %>%
                           filter(source == "avail") %>%
                           pull(prop)
                         set.seed(6)
                         mn_test = EMT::multinomial.test(observed = obs_n,
                                                         prob = exp_prop,
                                                         useChisq = F,
                                                         MonteCarlo = T,
                                                         ntrial = 1e5)
                         return(mn_test)
                         })),
           mn_test = map(mn_test,
                         "result"),
           mn_test_stat = map_chr(mn_test, 
                                  "stat"),
           mn_p_value = map_dbl(mn_test,
                                "p.value")) %>%
  mutate(g_test = map(data,
                      .f = function(x) {
                        g_test = x %>%
                          select(-prop) %>%
                          pivot_wider(names_from = source,
                                      values_from = n_found) %>%
                          select(avail, use) %>%
                          as.matrix() %>%
                          DescTools::GTest(correct = "yates")
                        
                        return(g_test)
                      }),
         g_test_stat = map_chr(g_test,
                               "method"),
         g_p_value = map_dbl(g_test,
                             "p.value")) %>%
  mutate(chi2_test = map(data,
                         .f = function(x) {
                           obs_n = x %>%
                             filter(source == "use") %>%
                             pull(n_found)
                           exp_prop = x %>%
                             filter(source == "avail") %>%
                             pull(prop)
                           chi_test = stats::chisq.test(x = obs_n,
                                                        p = exp_prop)
                           return(chi_test)
                           }),
         chi2_test_stat = map_chr(chi2_test,
                                  "method"),
         chi2_p_value = map_dbl(chi2_test,
                                "p.value"))

  
```

```{r cover-tab}
cover_tab = cover_test %>%
  select(sin_cat,
         g_p_value,
         chi2_p_value) %>%
  rename(`Sinuosity Category` = sin_cat,
         `G-test p-value` = g_p_value,
         `Chi Squared p-value` = chi2_p_value) %>%
  kable(digits = 5,
        caption = "P-values of G- and Chi-squared tests for differences in availability of cover within 1.5 m radius between available and selected habitat.") %>%
  kable_styling(position = "center", 
                full_width = F)
cover_tab

```


# Discussion

## Habitat Availability Power Analysis
<!-- You can consider removing the headings within the Discussion after you get it buttoned up. I like breaking up the Methods and Results so that the reader can easily go back and forth, but within the Discussion it always seems to break up the flow a bit. The Methods and Results should be more "sciency" whereas the Discussion can be a little more informal.-->

The distributions of the depths and velocities from the sampled transects and the rasters covering the entirety of the lower Lemhi River are nearly identical within each sinuosity class. This suggest that the sampled transects are capturing the distribution of available habitat well, and did not need to be supplemented with additional transects. Certainly, we are interested in habitat metrics other than depth and velocity, but without somehow simulating the true distributions of those metrics (e.g., substrate class, fish cover, etc.)) it would be difficult to conduct a worthwhile power analysis to evaluate whether our current dataset is sufficient to capture those distributions. Depth and velocity were used as proxies for everything else, because we had model outputs for them across the entire Lemhi River, which we treated as the "truth". We feel that the habitat availability dataset available from line transects in the lower Lemhi River is sufficient to capture the true available habitat.

## Habitat Preference

### Sinuosity

With no real pattern in fish use relative to reaches categorized by low, medium or high sinuosity, it appears that fish are not selecting for habitat at the reach scale. 

### Depth and Velocity

While our analysis showed a statistically significant difference between the mean water depth that fish were using compared to available depths, sampling bias excluded deeper detected tag locations from the dataset because those locations were not safe to measure.  While we're not sure, had these omitted data points been included, a statistically significant difference may not have been calculated. 

Alternatively, we feel the statistically significant difference in the velocities found at used habitat locations compared to available habitat is a valid analysis. Had higher velocities been included in the dataset to potentially shift the use distribution, those locations would have been filtered out based on literature detailing the upper limit of sustained swimming for juvenile salmonids (used as criteria in decision tree for qualifying habitat use). Strikingly, the mean velocity for available habitat (0.99 m/s) is significantly greater than the upper limit for sustained swimming speed (0.67 m/s) of a 111 mm fish, the average size Chinook in the study .

### Channel Unit Type

Statistical analysis shows juvenile Chinook selecting for pools and off-channel areas at a higher frequency than what is available.  This supports the idea that these fish are seeking refuge from high velocities (i.e., riffles) which could be an important survival and fitness strategy during the winter months when fish are trying to maintain condition factor.

### Concealment

Contrary to our hypothesis, there was more concealment habitat available in the lower Lemhi than what was being used by juvenile Chinook.  One reason for this may be explained by fish seeking slow water habitat.  Generally, slow water habitat is associated with finer bed material (i.e., gravel, sands, fines) deposition. So, fish may not be selecting for areas where concealment is absent but rather low velocity is a more important habitat component than substrate concealment.  Also, while surveyors did their best to categorize substrate accurately, turbidity in the Lemhi River, especially at higher winter flows, made substrate observations challenging.

### Cover

Statistical analysis shows that fish use habitat with cover in significantly greater proportions that what is available to them. This analysis is likely understated too.  Because microhabitat availability surveys were conducted in August, overhanging vegetation was likely more prominent with leaves.  In the winter, during microhabitat use surveys, trees and plants had lost their leaves resulting in less available cover. How significant this may be is questionable but should be considered in the context of the seasonality of the two surveys.  

### Conclusions 

From our observations and analysis of winter habitat use in the lower Lemhi River, we conclude that juvenile Chinook are selecting for slow-water microhabitat with cover. Our habitat availability surveys and analysis suggest that this habitat type is limited in the lower Lemhi.  We think this information supports previous research conducted in the Lemhi River and help guide restoration efforts.  

While we believe this habitat availability and use study has been worthwhile and its findings are relevant to restoration efforts in the Lemhi River, it must be understood that the study does not come without some major confounding factors.  Those factors include:

* Radio telemetry technology
* Predation
* Sample size
* Sampling bias due to environmental conditions

Because we were unable to confirm if radio tag detections were truly live fish and a high percentage of radio were physically recovered (22% of detected tags during microhabitat surveys), we hypothesize that tag antennas became entangled with physical habitat features when fish sought cover resulting in shed tags. Predation also likely contributed to the high tag recovery rate. 
Ideally, we would have had a larger sample size of habitat use observations for a more robust analysis and better representation of the population sampled. 

Largely due to environmental conditions microhabitat use surveys were not always feasible during certain times of the winter or in certain sections of the river.  When the river was not navigable by boat due to surface ice, we were forced to conduct surveys by foot which limited access to only those areas where we had landowner permission.  Also, river conditions prevented us from collecting all desired metrics (i.e., depth and velocity) at all detected tag locations.


# Literature Cited
