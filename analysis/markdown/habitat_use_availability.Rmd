---
title: "Habitat Use versus Availability by Juvenile Chinook Salmon in Winter Months, Lemhi River"
author:
  - Tulley Mackey:
      email: tulley.mackey@mthoodenvironmental.com
      institute: [mhe_salmon]
      correspondence: true
  - Kevin E. See:
      email: Kevin.See@dfw.wa.gov
      institute: [wdfw]
      correspondence: false
  - Nick Porter:
      email: Nicholas.Porter@merck.com
      institute: [biomark]
      correspondence: true
  - Mike Hall:
      email: Mike.Hall1@merck.com
      institute: [biomark]
      correspondence: false
  - Richie Carmichael:
      email: Richard.Carmichael@merck.com
      institute: [biomark]
      correspondence: false
  - Michael W. Ackerman:
      email: mike.ackerman@mthoodenvironmental.com
      institute: [mhe_mccall]
      correspondence: true 
institute:
  - mhe_salmon: Mount Hood Environmental, 1009 South Daisy Street, Salmon, Idaho, 83467, USA
  - wdfw: Washington Department of Fish and Wildife, Fish Program, Science Division, 1111 Washington Street NE, Olympia, Washington, 98501, USA
  - biomark: Biomark, Inc., 705 South 8th Street, Boise, Idaho, 83702, USA
  - mhe_mccall: Mount Hood Environmental, PO Box 4282, McCall, Idaho, 83638, USA
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2:
    theme: yeti
    toc: yes
    toc_depth: 2
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    number_sections: yes
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
  bookdown::word_document2:
    fig_caption: yes
    reference_docx: "../templates/template.docx"
    number_sections: FALSE
    toc: no
    always_allow_html: true
    fig_width: 6
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua  
csl: "../templates/american-fisheries-society.csl"
bibliography:
  - AckermanLibrary.bib
always_allow_html: yes
---

```{r setup, echo = FALSE, message = F, warning = F}
library(here)
library(knitr)
library(kableExtra)

knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  comment = "#>",
  fig.path = here("analysis/figures//"),
  dpi = 300
)

```

```{r packages}
# load packages
library(tidyverse)
library(here)
library(magrittr)
library(janitor)
library(sf)
library(EMT)
library(DescTools)
library(broom)

theme_set(theme_bw())

```

```{r load-data}
# habitat availability and use datasets
load(here("analysis/data/derived_data/habitat_available.rda"))
load(here("analysis/data/derived_data/habitat_use.rda"))
```

```{r clean-data}
xs_all = xs_use %>%
  mutate(source = "use") %>%
  bind_rows(xs_avail %>%
              mutate(source = "avail")) %>%
  clean_names() %>%
  # improve some column names
  rename(release_loc = location,
         release_date = release,
         xs_name = name,
         stream_name = stream_nam,
         sin_cat = category,
         frazil_ice = frazel_ice) %>%
  # correct the code for small side channels
  mutate(channel_unit_type = recode(channel_unit_type,
                                     `SC` = "SSC"))%>%
  # round distance to cover to nearest 0.1m and rename
  mutate(distance_to_cover = round(distance_to_cover_round_to_nearest_0_1m, 1)) %>%
  select(-distance_to_cover_round_to_nearest_0_1m) %>%
  # fix some names within dominant substrate and reorder levels
  mutate(dominant_substrate_1mx1m = fct_recode(dominant_substrate_1mx1m,
                                               Boulder = "boulder",
                                               Cobble = "cobble",
                                               Fines = "silt_fines",
                                               Sand = "sand",
                                               Gravel = "gravel"),
         dominant_substrate_1mx1m = fct_relevel(dominant_substrate_1mx1m,
                                                "Gravel",
                                                after = 2),
         dominant_substrate_1mx1m = fct_relevel(dominant_substrate_1mx1m,
                                                "Sand",
                                                after = 3)) %>%
  # add a variable of whether there's any cover present within 1.5m
  mutate(has_cover = if_else(dominant_cover_type_1_5m_radius %in% c("No Cover", "Unknown") |
                               is.na(dominant_cover_type_1_5m_radius), "No", "Yes")) %>%
  # add variable for new selected habitat (filtering out duplicate selected locations 
  mutate(habitat_selected_new = if_else(habitat_selected == "Selected" & same_location_as_last_survey == "no", "Yes", "No"))

xs_summary = xs_all %>%
  filter(source == "avail") %>%
  group_by(xs_name, sin_cat) %>%
  summarise(n_pts = n_distinct(xs_point_number))

```

# Background

Degradation of tributary habitat has been implicated as a major factor contributing to declines of Pacific salmon *Oncorhynchus* spp. and has shown to reduce salmonid carrying capacity of freshwater ecosystems ##(Beechie et al 2013b)##. Tributary habitat rehabilitation efforts have been employed for decades to stem population declines ##(Bernhardt et al 2005)##. However, habitat use and preference for juvenile salmonids to inform those rehabilitation actions, particularly during winter months, are not well documented [@Huusko2007]. 

Habitat requirements for fish include physical and biological components necessary to complete life histories and ensure population viability [@Newcomb2007; @Rosenfeld2003]. Habitat availability can be defined as the accessibility of such components by a fish [@Johnson1980]. Alternatively, habitat use is the way a fish exploits the physical and biological resources available to them [@Favrot2018]. Habitat suitability measures a specific available habitat's capacity to support a fish, the most suitable habitats being optimal [@Bovee1986]. Available habitats can be hierarchically characterized by a spectrum ranging from least suitable (i.e., avoided) to most suitable (i.e., optimal). Habitat selection is determined when a fish chooses a physical or biological component from a spectrum of available habitats [@Johnson1980]. If habitat use is proportionally equivalent to habitat availability (i.e., no preference), then habitat use is considered random. However, when a fish selects for a specific physical or biological component given that multiple habitat types are available, this is considered preferred habitat (e.g., laboratory experiment: @Johnson1980). Critical habitat provides components essential to sensitive life stages (e.g., early life history: @Pitlo1989, @Newcomb2007).  Winter habitat is thought be critical because of specific biological conditions required by fish for maintenance of body condition and survival during this time period [@Favrot2018]. However, due to extreme environs (e.g., surface ice), little research has characterized winter microhabitat use and suitability empirically for Pacific salmon juveniles [@Huusko2007].


## Objectives

Quality winter rearing habitat has been identified as a limiting factor for Chinook salmon *O. tshawytscha*in the Lemhi River in eastern Idaho ##(Integrated Rehabilitation Assessment 2020)##. Restoration practitioners have prioritized the lower Lemhi River for rehabilitation efforts aimed at improving habitat for juvenile salmonids. To help identify target habitat conditions and guide restoration efforts, the goal of this study was to characterize microhabitat use and preference for juvenile Chinook salmon in the lower Lemhi River (below its confluence with Hayden Creek) during late fall and winter months. Habitat availability and use data were collected in the lower Lemhi River using methods similar to those described by @Favrot2018, which were previously implemented in Catherine Creek, Oregon. Habitat availability and use data were then analyzed to describe habitat selection and preference of juvenile Chinook salmon overwintering in the lower Lemhi River.

Here, we use the term "presmolts" to refer to juvenile Chinook salmon overwintering in the lower Lemhi River i.e., juveniles surviving to their first winter prior to spring emigration.


# Methods

## Habitat Availability

```{r hab-avail-data}
load(here("analysis/data/derived_data/center_pts_all.rda"))

```

Microhabitat availability data were collected in the lower Lemhi River using line-transect survey techniques similar to those described by @Favrot2018. Line-transect techniques can minimize measurement error and are more repeatable than visual techniques [@McMahon1996; @Stanfield1998]. Microhabitat availability data were collected during base-flow conditions in August 2019 and variables measured at each transect point corresponded to microhabitat use variables (described below). Points were placed every meter along a linear network of the lower Lemhi River from its confluence with Hayden Creek downstream to its confluence with the Salmon River, resulting in `r prettyNum(nrow(center_pts_all), big.mark = ",")` points in total. Each point was then categorized as occurring within a low, medium, or high sinuosity reach (calculated at the 500m reach scale) of the lower Lemhi River (Table \@ref(tab:sin-table)).

```{r sin-table}
sin_tbl = center_pts_all %>%
  st_drop_geometry() %>%
  group_by(Category) %>%
  summarize(Minimum = min(Sinuosity),
            Maximum = max(Sinuosity),
            `Length (m)` = n(),
            .groups = "drop") %>%
  kbl(caption = "The number of points within each sinuosity category including the minimum and maximum sinuosity values for reach category.",
      format.args = list(digits = 4,
                         big.mark = ",")) %>%
  kable_styling(position = "center", full_width = F)
sin_tbl

```

We then randomly sampled an approximately equal number of points within each sinuosity category (Table \@ref(tab:xs-table)) and transects were placed at a right angle to the flow at each of the sampled points. At each transect, we then started at the wetted width midpoint of the river and sampled every meter to river right and river left (facing downstream), including the midpoint, to the wetted margin. The midpoint was designated as the zero point, points to river right were designated positive (+) and points towards river left were designated negative (-). Habitat availability measurements were taken at each point and described channel unit type, bank condition, dominant substrate, availability of substrate concealment, presence of adjacent side channels, dominant cover type, and distance to cover. In addition, depth and velocity estimates for each point were available from LiDAR-derived 2D numerical models ##(Tonina et al 2020)##. In total, habitat measurements were collected from `r nrow(xs_summary)` transects and `r prettyNum(sum(xs_summary$n_pts), big.mark = ",")` points, resulting in an average of `r round(sum(xs_summary$n_pts) / nrow(xs_summary), 1)` points per transect.

```{r xs-table}
xs_tbl = xs_summary %>%
  group_by(Category = sin_cat) %>%
  summarize(`n Transects` = n(),
            `n Transect Points` = sum(n_pts),
            .groups = "drop") %>%
  mutate(`Avg. Points per Transect` = round(`n Transect Points` / `n Transects`, 1)) %>%
  kbl(caption = "The number of points within each sinuosity category including the minimum and maximum sinuosity values for reach category.",
      format.args = list(digits = 4,
                         big.mark = ",")) %>%
  kable_styling(position = "center", full_width = F)
xs_tbl

```

## Habitat Use

Microhabitat use data were collected from radio-tagged Chinook salmon presmolts monitored throughout the lower Lemhi River. A total of 279 fish were tagged from October 9 - 31, 2019 at three rotary screw trap (RST) locations in the Lemhi River: upper Lemhi RST, Hayden Creek RST, and lower Lemhi RST. Radio-tagged presmolts were then tracked in the lower Lemhi River beginning in November 2019 through March 2020. Advanced Telemetry Systems, Inc.(ATS; https://atstrack.com) radio transmitters (Model #ST100L) were surgically implanted into the abdomen of Chinook salmon presmolts, ranging in length from 98 - 138 mm and weight from 10.4 - 31.1 g. Fish were also implanted with a Passive Integrated Transponder tag (PIT tag). Tagged fish were held for a minimum of six hours in live wells and released at night below the tagging sites once they had fully recovered from surgery.

Because of limited battery life, radio tags were programmed to operate in three batches to cover the entire winter season. Batch 1 transmitters (181 fish) were programmed to operate continuously upon activation, batch 2 transmitters (47 fish) operated for an hour upon activation then shutdown to reactivate at day 50, and batch 3 transmitters (51 fish) operated for an hour upon activation then shutdown to reactivate at day 100. Multiple batches were used to ensure that Chinook salmon presmolts could be monitored throughout the entire winter season.

Mobile tracking surveys were completed by boat and on foot, dependent on weather and river conditions.  Surveys covered 50 km of the lower Lemhi River from its confluence with Hayden Creek downstream to its confluence with the Salmon River and were completed approximately every two weeks. When a transmitter was detected, surveyors pin-pointed the signal location to the finest scale possible (typically <1 m$^2$), attempted to determine whether the tag was in a live fish, and recorded the location using an EOS Arrow 100 GNSS GPS receiver. The same habitat metrics collected for the habitat availability dataset were also collected at each tag location.  

```{r}
# filter for tags recovered by unique radio tag
use_recovered <- xs_use %>%
  filter(tag_status == "Recovered") %>%
  distinct(radio_frequency)

# summarize count of unique radio tags detected 
use_unique <- xs_use %>%
  distinct(radio_frequency) 

#summarize count of qualified, unique observations
use_selected <- xs_all %>%
  filter(habitat_selected_new == "Yes") 

#summarize count of qualified, unique observation by unique radio tag
unique_tag <- use_selected %>%
  distinct(radio_frequency)
```

Mobile tracking surveys resulted in `r nrow(xs_use)` detections of `r nrow(use_unique)` unique radio tags.  Of those `r nrow(use_unique)` tags, `r nrow(use_recovered)` were physically recovered from the river (one confirmed mortality). Confirmation of tag detections as live fish proved very difficult. So, to further refine our analysis to include only those locations we deemed utilized by fish, we used a decision tree (Figure \@ref(fig:tree-fig)) developed by combining information from @Holleman2022 and professional judgement. This resulted in `r nrow(use_selected)` unique habitat locations used by `r nrow(unique_tag)` fish.

```{r tree-fig, out.width = "600px", fig.align = "center", fig.cap = "Decision tree for determining qualified tag detection locations as selected habitat." }
knitr::include_graphics(here("analysis/images/D_tree.jpg"))

```

## Habitat Availability Power Analysis

```{r read_dv_data}
# read in depth and velocities from the habitat availability transects
load(here("analysis/data/derived_data/xs_raster.rda"))

# depth & velocity cross section values - sf object
dv_sf = xs_raster %>%
  select(-metric) %>%
  unnest(cols = sample_xs) %>%
  st_as_sf()

# depth & velocity cross section values - data frame
dv_df = dv_sf %>%
  st_drop_geometry() %>%
  as_tibble()

# get all available depths & velocities from the complete rasters
load("S:/main/data/habitat/lemhi_telemetry/availability/prepped/d_v_avail_sin.rda") # d_v_avail_sin

# compose a data frame for comparison
comp_df = dv_df %>%
  select(metric,
         sin_class,
         raster_val) %>%
  mutate(source = "sampled") %>%
  bind_rows(d_v_avail_sin %>%
              as_tibble() %>%
              select(-ID) %>%
              rename(raster_val = value) %>%
              mutate(source = "all")) %>%
  mutate(sin_class = factor(sin_class,
                            levels = c("Low", "Med", "High")),
         metric = str_to_title(metric))

```

##To determine if the 173 transects sampled for habitat availability were sufficient to capture the overall distribution of habitat metrics throughout the lower Lemhi River, we focused on depth and velocity measurements taken at each transect point. We compared the distributions of those measured values with the distributions of all depth and velocity values available from raster datasets derived from 2D numerical flow models by performing a Kolmogorovâ€“Smirnov  test on data from each sinuosity category . If the test is insignificant, this indicates that the data from the transects described the distribution of available habitat well. We were only able to perform this test on depth and velocity because they were the only metrics with data available for the entire section of the lower Lemhi. Our assumption is that if the transect data is sufficient for depth and velocity, it also captures the distributions of the other habitat metrics as well.##

Prior to evaluating for habitat selection or preference, we first wanted to assess whether the habitat availability data collected during August 2019 was sufficient to capture the overall distribution of available habitat throughout the lower Lemhi River, or whether addition habitat availability data were needed. A total of `r nrow(xs_summary)` transects (cross-sections) were sampled during August 2019 based on a stratified sample where strata were defined by low, medium, and high sinuosity (Tables \@ref(tab:sin-table) & \@ref(tab:xs-table)). We started by examining the depth and velocity values available from raster datasets derived from 2D numerical models for the entire lower Lemhi. We then extracted depth and velocity values from points along the sampled transects, and compared those distributions with the distributions of depth and velocity for the entire available raster. Our hypothesis is that if the distributions are similar between the entire raster and the sampled transects, then the sample has done an adequate job of capturing the distribution of available habitat.

## Habitat Preference

After filtering the identified radio tags to include only those fish that we deemed selected a given location, we then compared the total available habitat in the lower Lemhi River to the habitat that was selected by radio-tagged Chinook salmon presmolts. Comparisons were made for the following habitat characteristics:

* Sinuosity
* Stream Depth and Velocity
* Channel Unit Type
* Substrate Concealment
* Cover

### Sinuosity

We estimated the proportion of the total available habitat in the lower Lemhi River that fell into each of the sinuosity categories (Table \@ref(tab:sin-table)), which was compared to the proportion of each category that Chinook salmon presmolts used. 

### Depth and Velocity

Stream depth (m) and mean column velocity (m/s) were measured at 47 of the `r nrow(use_selected)` selected habitat locations during typical winter flows. Environmental conditions (surface ice and depth) at the time of sampling prevented safe collection of depth and velocity measurements at some locations. This likely introduced some bias, as some locations were excluded because they were too deep, and thus, unwadable. The bias was likely less prevalent for velocity measurements, as presmolt Chinook salmon tend to select areas of lower velocities during winter months [@Cunjak1996] and we were more able to sample those locations.

We compared the available depths and velocities for the entire lower Lemhi River (derived from 2D numerical modeling raster data) to the measured depths and velocities taken in the field during microhabitat use surveys. We used a variance test (F test; how far each data point is from the group mean), to evaluate variances between the habitat availability and habitat use datasets. This led us to use an unpooled, two-sample test (Welch test) to determine if there's a significant difference (p-value < 0.05) between mean available depth and velocity and mean selected depth and velocity.     

### Channel Unit Type

Channel unit types included pools, riffles, runs, rapid+, small side-channels (SSC), and off-channel areas (OCA), similar to channel units delineated using the DASH protocol [@Carmichael2019]. Because there are multiple types of channel units, we employed a goodness-of-fit test for discrete multivariate data. This test compares the observed channel unit types that radio-tagged juveniles were observed using to the proportion of channel unit types from the habitat availability dataset. The null hypothesis was that radio-tagged juvenile Chinook salmon would be found in channel units in the same (or similar) proportion to what is available. Because there are `r n_distinct(xs_all$channel_unit_type)` distinct channel unit types, this leads to a large number of potential arrangements. Therefore, we used a Monte Carlo approach to simulate `r prettyNum(1e5, scientific=FALSE, big.mark = ",")` samples of $n$ observations ($n$ being the number of selected "use" channel units) using the habitat availability proportions of channel unit types. The p-value is then calculated by summing the relative frequencies of outcomes occurring less frequently than the observed ones, so a low p-value indicates that the observed "use" channel types are distributed differently that the available ones, suggesting that fish are not randomly distributed in overwinter habitat. We also used a log likelihood ratio goodness of fit test (G-test).

### Concealment

At each point of habitat availability transects and at observed "use" locations by radio-tagged individuals, we estimated whether concealment habitat was available to Chinook salmon presmolts. Determinations of concealment availability were made using professional judgement that included observations of substrate size and embeddedness. Because concealment is binary (either available or not), we tested whether there were differences between habitat availability and use using a Chi-squared test, as well as a G-test.

### Cover

We determined whether fish cover was available within 1.5 m of each habitat availability transect point and at each "use" location. Cover types considered included artificial cover, aquatic vegetation, boulders, small and large wood, terrestrial vegetation, and undercut banks. Here, we grouped all types of cover into a single category, and compared whether cover was available with the category of "no cover". This resulted in a binary variable, like concealment, allowing us to also use the Chi-squared and G-test.


# Results

## Habitat Availability Power Analysis

Comparisons of the distributions of depths and velocities estimated from 1) the randomly placed transects used to estimate habitat availability, and 2) the entirety of the rasters derived from 2D numerical models were favorable (Figure \@ref(fig:dist-fig)). Distributions of depths and velocities were similar among all sinuosity categories (Figure \@ref(fig:dist-fig)). These findings suggest that the habitat availability data collected during August 2019 were sufficient to capture the available habitat throughout the lower Lemhi River.

```{r dist-fig, fig.cap = "Density plots of depth and velocity, colored by whether taken from the entire raster (all) or the sampled transects (sampled), and faceted by sinuosity category."}
comp_df %>%
  mutate(source = recode(source,
                         `sampled` = "Sampled",
                         `all` = "All")) %>%
  ggplot(aes(x = raster_val,
             color = source,
             fill = source)) +
  geom_density(alpha = 0.3) +
  scale_color_brewer(palette = 'Set1',
                     name = 'Source') +
  scale_fill_brewer(palette = 'Set1',
                     name = 'Source') +
  facet_grid(sin_class ~ metric,
             scales = 'free') +
  # facet_wrap(~ metric + sin_class, 
  #            scales = 'free',
  #            nrow = 2) +
  theme(legend.position = "bottom") +
  labs(x = 'Raster Value')

```

## Habitat Preference

### Sinuosity

Sinuosity categories selected by radio-tagged Chinook salmon presmolts were similar to the proportions of available habitat (Figure \@ref(fig:sin-use)), suggesting habitat use by sinuosity category was random. In other words, presmolts were *not* observed using "high" sinuosity reaches of the lower Lemhi River at a higher rate than was available, as we might expect. This result is further considered below in the [Discussion](#discussion) section.

```{r sin-use, fig.cap = "Proportion of available and selected habitat by sinuosity category in the lower Lemhi."}
# percentage available habitat by sinuosity
sin_all <- center_pts_all %>%
  st_drop_geometry() %>%
  select(Category) %>%
  count(Category) %>%
  mutate(Percentage = n/sum(n)) %>%
  add_column(Habitat = "Available")

# percentage use habitat by sinuosity 
sin_use <- xs_use %>%
  filter(habitat_selected == "Selected" & same_location_as_last_survey == "no") %>%
  select(Category) %>%
  count(Category) %>%
  mutate(Percentage = n/sum(n)) %>%
  add_column(Habitat = "Used") %>%
  bind_rows(sin_all) %>%
  ggplot(mapping = aes(x=Category, 
                       y=Percentage, 
                       fill = Habitat)) +
  geom_bar (position = "dodge", 
            stat = "identity") +
  scale_fill_brewer(palette = "Set2") +
  theme(plot.title = element_text(hjust = 0.5), 
        legend.position = "bottom") +
  ylab("Proportion") +
  xlab("Sinuosity Category")
sin_use

```

### Depth and Velocity

Distributions between available stream depths and depths used by Chinook salmon presmolts were similar (Figure \@ref(fig:depth-fig)); despite the "used" mean depth being significantly lower than the available mean (p < 0.05; Table \@ref(tab:depth-tab)). However, this significance could (at least partially) be explained by a potential sampling bias considered in the [Discussion](#discussion) section.

```{r depth-fig, fig.cap = "Distributions of all available stream depths (m) and velocities (m/s) in the lower Lemhi River derived from a 2D numerical model (available) and depths (m) and velocities (m/s) used by radio-tagged juvenile Chinook salmon during late fall and winter months (use)."}
# boxplot comparisons for available/use depths/velocities
d_v_avail = d_v_avail_sin %>%
  rename("Habitat" = sin_class) %>%
  mutate(Habitat = recode(Habitat,
                          'High'= "Available", 'Med'= "Available", 'Low' = "Available")) %>%
  select(Habitat, value, metric)

use_d_v <- use_selected %>%
  select(depth_m, mean_column_velocity) %>%
  rename("depth" = depth_m, "velocity" = mean_column_velocity) %>%
  pivot_longer(depth:velocity) %>%
  rename("metric" = name) %>%
  na.omit(value) %>%
  add_column(Habitat = "Used") %>% 
  bind_rows(d_v_avail)

plot_d_v <- use_d_v %>%
  ggplot(aes(x = metric,
             y = value,
             fill = Habitat)) +
  geom_boxplot() +
  theme(axis.text.x = element_blank(),
        legend.position="bottom") +
  scale_fill_brewer(palette = "Set2") +
  facet_wrap(~ metric) +
  labs(x = "",
       y = "Value")

plot_d_v

```

```{r depth-tab}
# Welch t-test for depth
stat_depth <- use_d_v %>%
    filter(metric == "depth")
    
  depth_tab = t.test(value ~ Habitat, data = stat_depth) %>%
    tidy() %>%
    select(estimate1,
           estimate2,
           p.value) %>%
    rename(`Mean Available Depth (m)` = estimate1,
           `Mean Used Depth (m)` = estimate2,
           `Welch t-test p-value` = p.value) %>%
  kable(caption = "Estimated mean depth for available and used habitat and Welch t-test p-value.") %>%
  kable_styling(position = "center", 
             full_width = F)
depth_tab

```

Mean stream velocities used by Chinook salmon presmolts were significantly lower than those available throughout the lower Lemhi River (Figure \@ref(fig:depth-fig)); Table \@ref(tab:vel-tab)), suggesting that presmolts were selecting for slower water habitats during late fall and early winter months.

```{r vel-tab}
# Welch t test for velocity
stat_vel <- use_d_v %>%
    filter(metric == "velocity")

vel_tab = t.test(value ~ Habitat, data = stat_vel) %>%
    tidy() %>%
    select(estimate1,
           estimate2,
           p.value) %>%
    rename(`Mean Available Velocity (m/s)` = estimate1,
           `Mean Used Velocity (m/s)` = estimate2,
           `Welch t-test p-value` = p.value) %>%
  kable(caption = "Estimated mean velocity for available and used habitat and Welch t-test p-value.") %>%
  kable_styling(position = "center", 
                full_width = F)
vel_tab

```

### Channel Unit Type

There were significant differences in the distribution of channel unit types used by Chinook salmon presmolts and what was available throughout the lower Lemhi River.  We can see that the proportion of slow water habitat (i.e., pools, runs, OCAs) being used in larger percentages than what is available in the lower Lemhi River (Figure \@ref(fig:cu-per)).  This applies to small side channel habitat too.  When we use the same comparison in the context of the three sinuosity categories, we see similar results (Table \@ref(tab:cu-tab)). Presmolts appear to use pools and off-channel areas at a higher proportion relative to their availability, and riffles at a lower proportion compared to what is available across all sinuosity categories (Figure \@ref(fig:cu-fig)).

```{r cu-per, fig.cap = "Proportion of channel unit types available in the lower Lemhi River versus those observed being used by radio-tagged Chinook salmon presmolts."}
# compare percent of available and used channel unit types
cu_use <- xs_all %>%
  filter(habitat_selected_new == "Yes") %>%
  select(channel_unit_type) %>%
  count(channel_unit_type) %>%
  mutate(percent = (n/sum(n))) %>%
  add_column(Habitat = "Used")

cu_per <- xs_avail %>%
  select(channel_unit_type) %>%
  count(channel_unit_type) %>%
  mutate(percent = (n/sum(n))) %>%
  mutate(channel_unit_type = recode(channel_unit_type, SC="SSC")) %>%
  add_column(Habitat = "Available") %>%
  bind_rows(cu_use) %>%
  ggplot(mapping = aes(x = channel_unit_type,
                       y = percent,
                       fill = Habitat)) +
  geom_bar (position = "dodge", stat = "identity") +
  scale_fill_brewer(palette = "Set2") +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom") +
  ylab("Proportion") +
  xlab("")
cu_per
```

```{r cu-fig, fig.cap = "Proportion of channel unit types available in the entire lower Lemhi compared with percent where fish were using them, faceted by low, medium and high sinuosity classes."}
# channel unit bar plot by sinuosity category
cu_fig = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  mutate(source = recode(source,
                         `avail` = "Available",
                         `use` = "Used")) %>%
 ggplot(aes(x = source,
             fill = channel_unit_type)) +
  geom_bar(position = position_fill()) +
  scale_fill_brewer(palette = "Set2",
                    name = "CU Type") +
  facet_wrap(~ sin_cat) +
  labs(x = "",
       y = "Proportion")
cu_fig

```

```{r cu-test}
cu_prop_test = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  group_by(sin_cat, 
           source,
           channel_unit_type) %>%
  summarize(n_found = n(),
            .groups = "drop") %>%
  # fill in missing groups w/ NA
  full_join(tidyr::expand(.,
                          sin_cat,
                          source,
                          channel_unit_type),
            by = c("sin_cat",
                   "source",
                   "channel_unit_type")) %>%
  # replace NAs with 0s
  mutate(across(n_found,
                replace_na,
                0)) %>%
  # calculate proportions
  group_by(sin_cat,
           source) %>%
  mutate(prop = n_found / sum(n_found)) %>%
  ungroup() %>%
  arrange(sin_cat,
          source,
          channel_unit_type) %>%
  # nest data by sinuosity category
  nest(data = -sin_cat) %>%
  mutate(mn_test = map(data,
                       .f = purrr::quietly(function(x) {
                         obs_n = x %>%
                           filter(source == "use") %>%
                           pull(n_found)
                         exp_prop = x %>%
                           filter(source == "avail") %>%
                           pull(prop)
                         set.seed(6)
                         mn_test = EMT::multinomial.test(observed = obs_n,
                                                         prob = exp_prop,
                                                         useChisq = F,
                                                         MonteCarlo = T,
                                                         ntrial = 1e5)
                         return(mn_test)
                       })),
         mn_test = map(mn_test,
                       "result"),
         mn_test_stat = map_chr(mn_test, 
                             "stat"),
         mn_p_value = map_dbl(mn_test,
                           "p.value")) %>%
  mutate(g_test = map(data,
                      .f = function(x) {
                        obs_n = x %>%
                          filter(source == "use") %>%
                          pull(n_found)
                        exp_prop = x %>%
                          filter(source == "avail") %>%
                          pull(prop)
                        g_test = DescTools::GTest(x = obs_n,
                                                  p = exp_prop,
                                                  correct = "williams")
                        return(g_test)
                      }),
         g_test_stat = map_chr(g_test,
                               "method"),
         g_p_value = map_dbl(g_test,
                             "p.value"))

```

```{r cu-tab}
# channel unit table
cu_tab = cu_prop_test %>%
  select(sin_cat,
         mn_p_value,
         g_p_value) %>%
  rename(`Sinuosity Category` = sin_cat,
         `Multinomial p-value` = mn_p_value,
         `G-test p-value` = g_p_value) %>%
  kable(caption = "P-values of multinomial and G-tests for differences in channel unit type proportions between available and selected habitat.") %>%
  kable_styling(position = "center", 
                full_width = F)
cu_tab

```

### Concealment

We observed little difference between the proportion of locations where concealment substrate was available and locations used by Chinook salmon presmolts with concealment habitat, for both the medium and high sinuosity categories (Figure \@ref(fig:conceal-fig)). While it appears differently (due to sample size), we found no significant difference in concealment  for high sinuosity (Table \@ref(tab:conceal-tab)). There was a significant difference within the low sinuosity category (Table \@ref(tab:conceal-tab)); however; Figure \@ref(fig:conceal-fig) indicates that in low sinuosity reaches, fish were more likely to select habitat that does not contain substrate concealment, contrary to our suspicions.

```{r conceal-fig, fig.cap = "Proportion of locations where concealment habitat was available throughout the lower Lemhi River compared with the proportion where fish had selected, faceted by low, medium and high sinuosity classes."}
# concealment figure
conceal_fig = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  mutate(source = recode(source,
                         `avail` = "Available",
                         `use` = "Used")) %>%
  filter(substrate_concealment %in% c("N", "Y")) %>%
  ggplot(aes(x = source,
             fill = substrate_concealment)) +
  geom_bar(position = position_fill()) +
  scale_fill_brewer(palette = "Set2",
                    name = "Concealment") +
  facet_wrap(~ sin_cat) +
  labs(x = "",
       y = "Proportion")
conceal_fig

```

```{r conceal-test}
conceal_test = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  filter(substrate_concealment %in% c("N", "Y")) %>%
  mutate(across(substrate_concealment,
                fct_drop)) %>%
  group_by(sin_cat,
           source,
           substrate_concealment) %>%
  summarize(n_found = n(),
            .groups = "drop") %>%
  # fill in missing categories w/ NA
  full_join(tidyr::expand(.,
                          sin_cat,
                          source,
                          substrate_concealment),
            by = c("sin_cat",
                   "source",
                   "substrate_concealment")) %>%
  # fill in NAs
  mutate(across(n_found,
                replace_na,
                0)) %>%
  group_by(sin_cat, source) %>%
  mutate(prop = n_found / sum(n_found)) %>%
  ungroup() %>%
  arrange(sin_cat,
          source,
          substrate_concealment) %>%
  nest(data = -sin_cat) %>%
  mutate(mn_test = map(data,
                    .f = purrr::quietly(function(x) {
                      obs_n = x %>%
                        filter(source == "use") %>%
                        pull(n_found)
                      exp_prop = x %>%
                        filter(source == "avail") %>%
                        pull(prop)
                      set.seed(6)
                      mn_test = EMT::multinomial.test(observed = obs_n,
                                                      prob = exp_prop,
                                                      useChisq = F,
                                                      MonteCarlo = T,
                                                      ntrial = 1e5)
                      return(mn_test)
                    })),
         mn_test = map(mn_test,
                       "result"),
         mn_test_stat = map_chr(mn_test, 
                                "stat"),
         mn_p_value = map_dbl(mn_test,
                              "p.value")) %>%
  mutate(g_test = map(data,
                      .f = function(x) {
                        # obs_n = x %>%
                        #   filter(source == "Use") %>%
                        #   pull(n_found)
                        # exp_prop = x %>%
                        #   filter(source == "Avail.") %>%
                        #   pull(prop)
                        # g_test = DescTools::GTest(x = obs_n, 
                        #                           p = exp_prop,
                        #                           correct = "williams")
                        g_test = x %>%
                          select(-prop) %>%
                          pivot_wider(names_from = source,
                                      values_from = n_found) %>%
                          select(avail, use) %>%
                          as.matrix() %>%
                          DescTools::GTest(correct = "yates")
                        return(g_test)
                      }),
         g_test_stat = map_chr(g_test,
                               "method"),
         g_p_value = map_dbl(g_test,
                             "p.value")) %>%
  mutate(chi2_test = map(data,
                         .f = function(x) {
                           obs_n = x %>%
                             filter(source == "use") %>%
                             pull(n_found)
                           exp_prop = x %>%
                             filter(source == "avail") %>%
                             pull(prop)
                           chi_test = stats::chisq.test(x = obs_n, 
                                                        p = exp_prop)
                           return(chi_test)
                         }),
         chi2_test_stat = map_chr(chi2_test,
                                  "method"),
         chi2_p_value = map_dbl(chi2_test,
                                "p.value"))

```

```{r conceal-tab}
conceal_tab = conceal_test %>%
  select(sin_cat,
         g_p_value,
         chi2_p_value) %>%
  rename(`Sinuosity Category` = sin_cat,
         `G-test p-value` = g_p_value,
         `Chi Squared p-value` = chi2_p_value) %>%
  kable(digits = 5,
        caption = "P-values of G- and Chi-squared tests for differences in availability of concealment between available and selected habitat.") %>%
  kable_styling(position = "center", 
                full_width = F)
conceal_tab

```

### Cover

Chinook salmon presmolts were more likely to select habitat where some form of cover was available (within a 1.5 m radius), compared to what was available, including across all three sinuosity categories (Figure \@ref(fig:cover-fig); Table \@ref(tab:cover-tab)).

```{r cover-fig, fig.cap = "Proportion of transect points where cover was available throughout the entire lower Lemhi River compared to the proportion where fish had selected, faceted by low, medium, and high sinuosity categories."}
cover_fig = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  mutate(source = recode(source,
                         `avail` = "Available",
                         `use` = "Used")) %>%
  ggplot(aes(x = source,
             fill = has_cover)) +
  geom_bar(position = position_fill()) +
  scale_fill_brewer(palette = "Set2",
                    name = "Cover") +
  facet_wrap(~ sin_cat) +
  labs(x = "",
       y = "Proportion")
cover_fig
   
```

```{r cover-test}
cover_test = xs_all %>%
  filter(source == "avail" | habitat_selected_new == "Yes") %>%
  group_by(sin_cat,
           source,
           has_cover) %>%
  summarize(n_found = n(),
            .groups = "drop") %>%
  # add missing categories
  full_join(tidyr::expand(.,
                          sin_cat,
                          source,
                          has_cover),
            by = c("sin_cat",
                   "source",
                   "has_cover")) %>%
  # fill in NAs with 0
  mutate(across(n_found,
                replace_na,
                0)) %>%
  group_by(sin_cat, source) %>%
  mutate(prop = n_found / sum(n_found)) %>%
  ungroup() %>%
  arrange(sin_cat,
          source,
          has_cover) %>%
  nest(data = -sin_cat) %>%
  mutate(mn_test = map(data,
                       .f = purrr::quietly(function(x) {
                         obs_n = x %>%
                           filter(source == "use") %>%
                           pull(n_found)
                         exp_prop = x %>%
                           filter(source == "avail") %>%
                           pull(prop)
                         set.seed(6)
                         mn_test = EMT::multinomial.test(observed = obs_n,
                                                         prob = exp_prop,
                                                         useChisq = F,
                                                         MonteCarlo = T,
                                                         ntrial = 1e5)
                         return(mn_test)
                         })),
           mn_test = map(mn_test,
                         "result"),
           mn_test_stat = map_chr(mn_test, 
                                  "stat"),
           mn_p_value = map_dbl(mn_test,
                                "p.value")) %>%
  mutate(g_test = map(data,
                      .f = function(x) {
                        g_test = x %>%
                          select(-prop) %>%
                          pivot_wider(names_from = source,
                                      values_from = n_found) %>%
                          select(avail, use) %>%
                          as.matrix() %>%
                          DescTools::GTest(correct = "yates")
                        
                        return(g_test)
                      }),
         g_test_stat = map_chr(g_test,
                               "method"),
         g_p_value = map_dbl(g_test,
                             "p.value")) %>%
  mutate(chi2_test = map(data,
                         .f = function(x) {
                           obs_n = x %>%
                             filter(source == "use") %>%
                             pull(n_found)
                           exp_prop = x %>%
                             filter(source == "avail") %>%
                             pull(prop)
                           chi_test = stats::chisq.test(x = obs_n,
                                                        p = exp_prop)
                           return(chi_test)
                           }),
         chi2_test_stat = map_chr(chi2_test,
                                  "method"),
         chi2_p_value = map_dbl(chi2_test,
                                "p.value"))

  
```

```{r cover-tab}
cover_tab = cover_test %>%
  select(sin_cat,
         g_p_value,
         chi2_p_value) %>%
  rename(`Sinuosity Category` = sin_cat,
         `G-test p-value` = g_p_value,
         `Chi Squared p-value` = chi2_p_value) %>%
  kable(digits = 5,
        caption = "P-values of G- and Chi-squared tests for differences in availability of cover within 1.5 m radius between available and selected habitat.") %>%
  kable_styling(position = "center", 
                full_width = F)
cover_tab

```


# Discussion

In this study, we identified that radio-tagged Chinook salmon presmolts selected for slower stream velocities that were typically available in the lower Lemhi River; and further, selected for slow-water channel unit types, including pools and off-channel areas (Figure \@ref(fig:cu-per)), at a higher rate than those types were available. Chinook presmolts appeared to similarly select for small side channels (Figure \@ref(fig:cu-per)). Additionally, we identified that presmolts selected for locations with adjacent cover (of any type), regardless of the reach-scale sinuosity of the river. We did not identify a pattern of selection (or not) for concealment habitat. In the following, we further discuss these results including potential limitation that should be considered during interpretation.

Distribution of stream depths and velocities from the sampled transects and the rasters covering the entirety of the lower Lemhi River were nearly identical within each sinuosity class. This suggested that the sampled transects sufficiently captured the distribution of available habitat, and did not need to be supplemented with additional transects. Certainly, we were interested in habitat metrics beyond depth and velocity, but without somehow simulating the true distributions of those metrics (e.g., substrate class, fish cover, etc.)) it would have been difficult to conduct a worthwhile power analysis to evaluate whether the current dataset was sufficient to capture those distributions. Depth and velocity were used as proxies for other habitat characteristics, because we had model outputs for them across the entire lower Lemhi River, which we treated as the "truth". We feel that the habitat availability dataset available from line transects in the lower Lemhi River was sufficient to capture the true available habitat.

We hypothesized that Chinook salmon presmolts would select high sinuosity reaches in the lower Lemhi River at a higher rate than they were available; however, this was not the case (Figure \@ref(fig:sin-use)). There did not appear to be a real pattern in fish use relative to sinuosity categories, as classified. We suspected that "high" sinuosity reaches of the lower Lemhi River would be more likely to contain lower velocity habitats and slow-water channel units, which are typically more appealing to presmolts (supported by findings here). But that didn't necessarily seem to be the case here, as all sinuosity categories appeared to have similar distributions of velocity (Figure \@ref(fig:dist-fig)) despite high sinuosity reaches having higher pool frequency (Figure \@ref(fig:cu-fig)). These findings may suggest that Chinook salmon presmolts are not selecting for habitat at the reach (e.g., 500 m) scale, but rather at a more microhabitat scale. Additionally, these results may be impacted by the limitations of the 2-D LiDAR surface and resulting depth and velocity outputs utilized for the availability estimations. The propagation of elevation uncertainty in the LiDAR surface and the spatial resolution of the resulting numerical model outputs (1 m x 1 m) likely resulted in a smoothing effect across complex habitat often associated with higher sinuosity reaches. Further, error propagation was found to be most extreme in areas of high complexity and large amounts of cover, with steep banks and inflections (Tonina et al. 2020)

While our analysis demonstrated a significant difference between mean available depths in the lower Lemhi River and depths used by Chinook salmon presmolts (Table \@ref(tab:depth-tab)), with premolts selecting for shallower depths, we believe this results could at least partially be explained by a sampling bias. For example, stream depths were not collected at some fish use locations because, at the time of sampling, those locations were too deep or swift to safely and accurately measure. Had these omitted data points been included in the used dataset, bias in observed depths may have been reduced (albeit to an unknown degree), and a significant difference may not have been found. Alternatively, some locations where radio tags were detected were considered non-selected habitats based on stream velocities. Any locations with a stream velocity greater than 0.7 m/s were excluded as potential use locations because those velocities exceed sustained swimming capabilities of the average sized Chinook salmon tagged for this study [@Holleman2022]. 

Contrary to our hypothesis, there was more concealment habitat available in the lower Lemhi River than what was being used by presmolts, at least in low sinuosity reaches (Figure \@ref(fig:conceal-fig)). This may be partially explained by fish instead seeking and preferring slow velocity habitats, which are generally associated with finer bed material (i.e., gravel, sands, fines) deposition. Chinook salmon presmolts may not be selecting for areas where concealment is absent, but rather it may be that stream velocity is a more important habitat component than substrate concealment. Also, while surveyors did their best to categorize substrate accurately, turbidity in the Lemhi River, especially at higher winter flows, made substrate observations challenging.

We found that presmolts selected for microhabitats with cover (within a 1.5 m radius) in greater proportions than was available throughout the lower Lemhi River. Although we did not compare availability and use of dominant cover type (large and small wood, terrestrial and aquatic vegetation, boulder, and undercut bank), we don't believe the type of cover to be overly important, rather that some type of cover is readily available.

We believe findings from this study should prove useful for ongoing restoration efforts in the Lemhi River. However, there were some potential limitations that should be considered, which include:

* Limitations in radio telemetry tags and technology,
* Predation,
* Habitat use sample sizes, and
* Sampling bias due to harsh environmental conditions during winter months

In nearly all cases, we were unable to confirm whether radio tag detections (observations) were truly live fish, and further, `r nrow(use_recovered)` radio tags were physically recovered during surveys. In some cases, we suspect that tag antennas became entangled with physical habitat features (e.g., woody debris, large substrates) when fish sought cover, resulting in shed tags. Additionally, predation perhaps also contributed to the amount of radio tags recovered and created additional uncertainty on whether a detection was from a live presmolt or from a predatory species (e.g., bull trout).

Ideally, our habitat use observations would have spanned multiple winter seasons. However, due to concerns about tag burdens and presmolts becoming entangled with physical habitat features because of the external radio antenna, radio tagging activities were ceased after the 2019/2020 winter field season. Additional use observations would have allowed for a more robust assessment and better representation of the population as a whole; however, the "use" sample size (n = 74) was sufficient to perform significance tests. 

Largely due to environmental conditions, microhabitat use surveys were not always feasible during certain times of the winter or in certain sections of the river. When the river was not navigable by boat due to surface ice, we were forced to conduct surveys by foot which limited access to only those areas where we had landowner permission. Also, river conditions prevented us from collecting all desired metrics (i.e., depth and velocity) at all detected tag locations during certain times.

## Conclusions

We identified that Chinook salmon presmolts selected for slower velocity microhabitats and channel unit types, and preferred locations with cover. More specifically, slow water channel units (pool, run, and off-channel areas) accounted for 70.3% of the habitats used by presmolts whereas only 36.4% of available habitat consisted of slow water channel units (Figure \@ref(fig:cu-per)). Presmolts aim to maintain their body condition (weight) through winter months to increase their probability of survival during emigration through the mainstem corridors and to the ocean. Slow velocity areas allow presmolts to preserve energy and weight. Cover both provides opportunity for (helps create) small areas of reduced velocity while also allowing for predator avoidance. The goal for a presmolt is to survive until increasing or higher flows in the spring, as fat as possible, with the aim of maximizing the probability of survival. Through velocity and channel unit type analyses, we demonstrated that Chinook salmon presmolts preferred slower channel unit types (pools and off-channel areas; Figure \@ref(fig:cu-fig)), supporting the idea that these fish are seeking refuge from high velocities (i.e., riffles) which could be an important survival and fitness strategy during the winter months when fish are trying to maintain condition factor. We believe that restoration efforts in the lower Lemhi River with the goal of improving overwintering habitat should increase the amount and frequency of slow-water habitats with available cover.


# Literature Cited
